# å·¥ä½œæµåç§°
name: Sync-Images-to-ALIYUN-ACR
# å·¥ä½œæµè¿è¡Œæ—¶æ˜¾ç¤ºåç§°
run-name: ${{ github.actor }} is Sync Images to ALIYUN-ACR.
# æ€æ ·è§¦å‘å·¥ä½œæµ
on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# å·¥ä½œæµç¨‹ä»»åŠ¡ï¼ˆé€šå¸¸å«æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªæ­¥éª¤ï¼‰
jobs:
  syncimages:
    runs-on: ubuntu-24.04
    steps:
    - name: Checkout Repos
      uses: actions/checkout@v3

    # 1. ç™»å½• Docker Hub (å…³é”®ï¼è§£å†³æ‹‰å–æŠ¥é”™)
    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        registry: docker.io
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
        logout: false

    - name: Login to ALIYUN-ACR
      uses: docker/login-action@v3
      with:
        registry: crpi-cf3skza02u86mj4q.cn-chengdu.personal.cr.aliyuncs.com
        username: ${{ secrets.ALIYUN_USERNAME }}
        password: ${{ secrets.ALIYUN_PASSWORD }}
        logout: false 
        
    - name: Use Skopeo Tools Sync Image to ALIYUN-ACR
      run: |
        #!/usr/bin/env bash
        set -e
        
        # 2. å®šä¹‰ç›®æ ‡ä»“åº“å‰ç¼€ (ä½ çš„æ–°å‘½åç©ºé—´)
        TARGET_REGISTRY="docker://crpi-cf3skza02u86mj4q.cn-chengdu.personal.cr.aliyuncs.com/hong_mirror_k8s"

        # 3. å®šä¹‰åŒæ­¥å‡½æ•° (æ ¸å¿ƒé€»è¾‘)
        sync_image() {
          local source_image=$1
          local target_name=$2
          local target_tag=$3
          
          # æ‹¼æ¥å®Œæ•´çš„ç›®æ ‡åœ°å€
          local full_target="$TARGET_REGISTRY/$target_name:$target_tag"

          echo "----------------------------------------------------"
          echo "ğŸ” Checking: $target_name:$target_tag"
          
          # æ­¥éª¤ A: æ£€æŸ¥é˜¿é‡Œäº‘æ˜¯å¦å·²å­˜åœ¨è¯¥é•œåƒ
          # ä½¿ç”¨ $DEST_CREDS å‡­è¯è®¿é—®ç§æœ‰ä»“åº“
          if skopeo inspect "$full_target" > /dev/null 2>&1; then
            echo "âœ… [SKIP] Image already exists, skipping."
          else
            echo "ğŸš€ [SYNC] Image not found, starting copy..."
            echo "   Source: $source_image"
            echo "   Target: $full_target"
            
            # æ­¥éª¤ B: æ‰§è¡ŒåŒæ­¥
            # --override-os/arch: å¼ºåˆ¶åªåŒæ­¥ amd64ï¼Œè§£å†³é˜¿é‡Œäº‘ Blob å¤ç”¨æŠ¥é”™
            # --all: å¤åˆ¶æ‰€æœ‰å…³è”æ•°æ®
            skopeo copy --override-os linux --override-arch amd64 --all \
              "docker://$source_image" \
              "$full_target"
              
            echo "ğŸ‰ [DONE] Sync completed."
          fi
        }

        # ==================================================
        # 4. æ‰§è¡ŒåŒæ­¥æ¸…å• (åŒ…å«æ‰€æœ‰ä¾èµ–)
        # ==================================================

        # --- rancher ç»„ä»¶ ---
        sync_image "docker.io/rancher/shell:v0.3.1" "shell" "v0.3.1"
        sync_image "docker.io/rancher/mirrored-pause:3.6" "mirrored-pause" "3.6"
        sync_image "docker.io/rancher/rancher-agent:v2.10-head" "rancher-agent" "v2.10-head"
        sync_image "docker.io/rancher/rancher:v2.10-head" "rancher" "v2.10-head"

        # --- ray ç»„ä»¶ ---
        sync_image "quay.io/kuberay/operator:v1.5.0" "kuberay-operator" "v1.5.0"
        sync_image "docker.io/rayproject/ray-llm:2.52.1-py311-cu128" "ray-llm" "2.52.1-py311-cu128"
        sync_image "docker.io/rayproject/ray:2.52.1-py311-gpu" "ray" "2.52.1-py311-gpu"
        sync_image "docker.io/rayproject/ray:2.52.1-py311-cu128" "ray" "2.52.1-py311-cu128"

        # --- prometheus ç»„ä»¶ ---
        sync_image "docker.io/prom/prometheus:v2.45.0" "prometheus" "v2.45.0"
        sync_image "docker.io/grafana/grafana:10.0.3" "grafana" "10.0.3"

        # --- nvidia ç»„ä»¶ ---
        sync_image "nvcr.io/nvidia/k8s/dcgm-exporter:3.3.5-3.4.1-ubuntu22.04" "dcgm-exporter" "3.3.5-3.4.1-ubuntu22.04"
        sync_image "nvcr.io/nvidia/k8s-device-plugin:v0.18.0" "k8s-device-plugin" "v0.18.0"
        sync_image "nvcr.io/nvidia/pytorch:25.01-py3" "pytorch" "25.01-py3"

        # mysql é•œåƒ
        sync_image "docker.io/library/mysql:8.0.32" "mysql" "8.0.32"

        # multus cni é•œåƒ
        sync_image "ghcr.io/mellanox/ipoib-cni:v1.2.2" "ipoib-cni" "v1.2.2"
        sync_image "ghcr.io/k8snetworkplumbingwg/whereabouts:v0.9.2" "whereabouts" "v0.9.2"
        sync_image "ghcr.io/k8snetworkplumbingwg/multus-cni:v4.2.3" "multus-cni" "v4.2.3"
        # --- verl é•œåƒ ---
        sync_image "docker.io/verlai/verl:vllm011.latest" "verl" "vllm011.latest"

        # --- longhorn é•œåƒ ---
        sync_image "docker.io/longhornio/livenessprobe:v2.16.0-20250826" "livenessprobe" "v2.16.0-20250826"
        sync_image "docker.io/longhornio/longhorn-manager:v1.10.0-hotfix-1" "longhorn-manager" "v1.10.0-hotfix-1"
        sync_image "docker.io/longhornio/longhorn-share-manager:v1.10.0" "longhorn-share-manager" "v1.10.0"
        sync_image "docker.io/longhornio/longhorn-ui:v1.10.0" "longhorn-ui" "v1.10.0"
        sync_image "docker.io/longhornio/longhorn-engine:v1.10.0" "longhorn-engine" "v1.10.0"
        sync_image "docker.io/longhornio/longhorn-instance-manager:v1.10.0" "longhorn-instance-manager" "v1.10.0"
        sync_image "docker.io/longhornio/backing-image-manager:v1.10.0" "backing-image-manager" "v1.10.0"
        sync_image "docker.io/longhornio/csi-attacher:v4.9.0-20250826" "csi-attacher" "v4.9.0-20250826"
        sync_image "docker.io/longhornio/csi-provisioner:v5.3.0-20250826" "csi-provisioner" "v5.3.0-20250826"
        sync_image "docker.io/longhornio/csi-node-driver-registrar:v2.14.0-20250826" "csi-node-driver-registrar" "v2.14.0-20250826"
        sync_image "docker.io/longhornio/csi-resizer:v1.14.0-20250826" "csi-resizer" "v1.14.0-20250826"
        sync_image "docker.io/longhornio/csi-snapshotter:v8.3.0-20250826" "csi-snapshotter" "v8.3.0-20250826"
        sync_image "docker.io/longhornio/support-bundle-kit:v0.0.69" "support-bundle-kit" "v0.0.69"

        # --- å·¥å…·ç±» ---
        sync_image "gcr.io/kaniko-project/executor:v1.13.0" "kaniko-executor" "v1.13.0"

        # --- åŸºç¡€ä¾èµ– (Bitnami Legacy) ---
        # æ³¨æ„ï¼šè¿™é‡Œä½¿ç”¨äº†ä½ æä¾›çš„æœ€æ–° r9/r4/r5 ç‰ˆæœ¬
        sync_image "docker.io/bitnamilegacy/postgresql:16.4.0-debian-12-r9" "postgresql" "16.4.0-debian-12-r9"
        sync_image "docker.io/bitnamilegacy/redis:7.4.0-debian-12-r4"       "redis"      "7.4.0-debian-12-r4"
        sync_image "docker.io/bitnamilegacy/rabbitmq:3.13.7-debian-12-r5"   "rabbitmq"   "3.13.7-debian-12-r5"

        # --- Polyaxon æ ¸å¿ƒç»„ä»¶ (2.12.0-rc5) ---
        sync_image "docker.io/polyaxon/polyaxon-api:2.12.0-rc5"             "polyaxon-api"             "2.12.0-rc5"
        sync_image "docker.io/polyaxon/polyaxon-gateway:2.12.0-rc5"         "polyaxon-gateway"         "2.12.0-rc5"
        sync_image "docker.io/polyaxon/polyaxon-streams:2.12.0-rc5"         "polyaxon-streams"         "2.12.0-rc5"
        sync_image "docker.io/polyaxon/polyaxon-operator:2.12.0-rc5"        "polyaxon-operator"        "2.12.0-rc5"
        sync_image "docker.io/polyaxon/polyaxon-agent:2.12.0-rc5"           "polyaxon-agent"           "2.12.0-rc5"
        sync_image "docker.io/polyaxon/polyaxon-init:2.12.0-rc5"            "polyaxon-init"            "2.12.0-rc5"
        sync_image "docker.io/polyaxon/polyaxon-sidecar:2.12.0-rc5"         "polyaxon-sidecar"         "2.12.0-rc5"
        sync_image "docker.io/polyaxon/polyaxon-cli:2.12.0-rc5"             "polyaxon-cli"             "2.12.0-rc5"
        sync_image "docker.io/polyaxon/polyaxon-hpsearch:2.12.0-rc5"        "polyaxon-hpsearch"        "2.12.0-rc5"
        sync_image "docker.io/polyaxon/polyaxon-events-handlers:2.12.0-rc5" "polyaxon-events-handlers" "2.12.0-rc5"
        sync_image "docker.io/polyaxon/polyaxon-scheduler:2.12.0-rc5"       "polyaxon-scheduler"       "2.12.0-rc5"

        # --- Ingress Nginx ç»„ä»¶ ---
        sync_image "registry.k8s.io/ingress-nginx/controller:v1.10.1"         "controller"           "v1.10.1"
        sync_image "registry.k8s.io/ingress-nginx/kube-webhook-certgen:v1.4.1" "kube-webhook-certgen" "v1.4.1"

        # --- local-path-provisioner ç»„ä»¶ ---
        sync_image "docker.io/rancher/local-path-provisioner:v0.0.30" "local-path-provisioner" "v0.0.30"
        sync_image "docker.io/library/busybox:latest" "busybox" "latest"

        # --- mallanox rdma plugin ç»„ä»¶ ---
        sync_image "docker.io/mellanox/k8s-rdma-shared-dev-plugin:v1.3.2" "k8s-rdma-shared-dev-plugin" "v1.3.2"

        # --- kubeflow ç»„ä»¶ ---
        sync_image "docker.io/kubeflow/training-operator:v1-04f9f13" "training-operator" "v1-04f9f13"

        # --- kubernetes ---
        sync_image "registry.k8s.io/pause:3.10" "pause" "3.10"

        # --- Polyaxon ä¾èµ–çš„åŸºç¡€é•œåƒ ---
        sync_image "docker.io/library/alpine:3.19" "alpine" "3.19"

        # --- Volcano é•œåƒ ---
        sync_image "docker.io/volcanosh/vc-controller-manager:v1.9.1" "vc-controller-manager" "v1.9.1"
        sync_image "docker.io/volcanosh/vc-scheduler:v1.9.1" "vc-scheduler" "v1.9.1"
        sync_image "docker.io/volcanosh/vc-webhook-manager:v1.9.1" "vc-webhook-manager" "v1.9.1"